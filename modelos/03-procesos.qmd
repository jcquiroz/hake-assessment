---
title: "Procesos individuales y poblacionales"
description: "El modelo de evaluación es condicionado a varios supuesto sobre aspectos poblacionales e individuales. En esta página se describen los métodos y procesos analíticos realizados para configurar estos supuestos."
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = "center")
source("../R/functions.R")
```

## Crecimiento

```{r, warning=FALSE, echo=FALSE, message=FALSE}
#| classes: plain
#| tbl-column: margin
#| tbl-cap: "Estimaciones de parámetros VBGM para merluza del pacífico"
#| 
tibble::tribble(
  ~Parámetro, ~Sexo, ~Valor,
  "Linf",  "Hembras", 163.7, 
  "k",  "Hembras", 0.08,
  "Linf",  "Machos", 108.9, 
  "k",  "Hembras", 0.11
) |> 
  knitr::kable()
```

El crecimiento individual fue modelado por medio de una clave talla-edad modelada en base a los parámetros
descritos por el método de von-Bertalanffy (VBGM) para sexos conjunto. Varias estimaciones de crecimiento
fueron descritas en @AlvarezTrasvia2022, donde se proporcionaron estimaciones de longitud infinita
($L_{\infty}$), tasa de crecimiento individual ($k$) para machos y hembras.

La conversión desde talla a edad fue realizada asumiendo que los grupos de edad se describen por medio de una
talla modal (i.e., talla media) y su variación en el grupo (i.e., desviación estándar), asumiendo una
distribución normal. Para esto, se simuló la talla de reclutamiento a la pesquería desde las composiciones de
tamaños ([Datos/Tallas](../datos/01-tallas.qmd)) y se exploró el número de grupos de edad requeridos para
incorporar las tallas muestreadas (@fig-001).

```{r, warning=FALSE, echo=FALSE, message=FALSE}
#| fig-height: 5
#| fig-cap: "Participación de grupos de edad en el rango de tamaños (5-110 cm) que se incluye en el modelo."
#| label: fig-001
#| fig-column: page-inset-right


library(KScorrect)
library(tidyverse)
library(FSA)

# growth Hembras & Machos
nedades = 15
Linf    = (163.72 + 108.89)/2
k       = .9*(0.08 + 0.11)/2
Lo      = 15
t0      = 0
M       = 0.21

cv      = 0.2
tallas  = seq(2,110) #floor(Linf))

mu_edad = sigma_edad = NULL
mu_edad[1] = Lo;

for (i in 2:nedades) {
  mu_edad[i] = mu_edad[i-1]*exp(-k)+Linf*(1-exp(-k))
}
sigma_edad = cv*mu_edad

# mixture
propo1 <- rep(1/nedades,1,nedades)
N = rep(1,1,nedades)
prop <- for (i in 2:nedades) {
  N[i] = N[i-1]*exp(-M)
}
propo2 = N/sum(N)

x <- rmixnorm(n = 5000, mean = mu_edad, sd = sigma_edad, pro = propo2)

## Veamos
dbins = 2
set_tallas <- tibble(length = x) |> filter(length > 0) |> rowwise() |> 
  mutate(age = DLMtool::iVB(t0, k, Linf, length), bins = FSA::lencat(length, w=dbins)) |> 
  drop_na() |> mutate(agec = ceiling(age))

raw    <- xtabs(~bins+agec, data=set_tallas)
WR.key <- prop.table(raw, margin=1)
#View(WR.key)

maxedad = 18
wr.key <- WR.key[,c(1:maxedad)]

FSA::alkPlot(wr.key,"barplot", lbl.cex = 0.5, xlim = c(2,110), xlab = "Talla", ylab = "Proporción")
```

## Mortalidad Natural

Se empleó información previa para la mortalidad natural utilizada en evaluaciones realizadas en Estados Unidos
y Canadá. Los resultados del análisis utilizando el método de Hoenig (1983) respaldan el uso de una
distribución log-normal con una mediana de `M=0.21` y una desviación estándar logarítmica de `0.1`. La
sensibilidad a esta información ha sido evaluada extensamente en muchas evaluaciones anteriores de la merluza
del pacífico. Los supuestos sobre M suelen tener un impacto significativo en los resultados del modelo, pero
en ausencia de nueva información sobre `M`, ha habido pocas opciones para actualizar este parámetro.

## Escarpamiento

El valor del parámetro de escarpamiento de la función stock-recluta se fundamenta en datos de la mediana
(`0.79`) y los percentiles 20 (`0.67`) y 80 (`0.87`) de la meta-análisis de Myers et al. (1999) de la familia
Gadidae. Este valor se ha utilizado en evaluaciones de Estados Unidos desde 2007 y puede ser representado por
una distribución a-priori beta con parámetros 9.76 y 2.80, lo que resulta en una media de 0.777 y una
desviación estándar logarítmica de 0.113.

## Madurez

Los datos de la relación de fecundidad fueron actualizados para la evaluación de 2020 (Edwards et al., 2018b).
Estas muestras fueron recolectadas de la encuesta acústica, viajes de investigación acústica de invierno y
verano, del Programa de Observadores de Merluza en el Mar de EE. UU. a bordo de buques
capturadores-procesadores comerciales, y de la encuesta de arrastre de fondo de la costa oeste de EE. UU.
(Tabla XX). Las muestras de edades de 15 años en adelante fueron agrupadas tanto para la estimación de madurez
como para el peso por edad debido a tamaños de muestra limitados. En consecuencia, las estimaciones de edades
15+ se aplicaron a edades 15-20 con fines de modelado de la dinámica poblacional (Figura 12). Se encontró que
algunos peces de casi todas las edades eran funcionalmente inmaduros según los criterios histológicos, que es
una combinación de "reproductores intermitentes" que no desovarán en el año próximo y peces senescentes que
parecen no tener ovarios viables.

```{r, warning=FALSE, echo=FALSE, message=FALSE}
#| fig-height: 4
#| fig-cap: "Ojivas de madurez y fecundidad. La fecundidad es el producto de la madurez y el peso medio. Los valores informados para las edades de 15 años en adelante representan el promedio en todas las muestras en este rango."
#| label: fig-002
#| fig-column: page-inset-right

ogive <- read_table("data/ogive.csv") |> pivot_longer(cols = 3:5, names_to = "ogive", values_to = "value")

ogive |> filter(ogive %in% c("madurez","fecundidad")) |> ggplot(aes(x = age, y = value)) + geom_vline(xintercept = 2.41, linetype = 2, linewidth = 0.4, color = "#5b613c") + geom_hline(yintercept = 0.5, linetype = 2, linewidth = 0.4, color = "#5b613c") + geom_path(aes(colour = ogive), lineend = "round", linewidth = 1) + mitheme2(bz = 11) + labs(color = "Ojiva", x = "Edad", y = "Proporción") + scale_colour_manual(values = mycolor[c(9,2)])
```
