---
title: "Procesos poblacionales"
subtitle: "Métodos y supuestos de la evaluación"
date: "Octubre, 2024"
description: ""
---

```{r setup, include=FALSE}
source("../R/functions.R")
library(gt)
library(KScorrect)
library(tidyverse)
library(FSA)
```

## Crecimiento

```{r, warning=FALSE, echo=FALSE, message=FALSE}
#| classes: plain
#| tbl-column: margin
#| tbl-cap: "Estimaciones de parámetros VBGM para merluza del pacífico"
#| 
tibble::tribble(
  ~Parámetro, ~Sexo, ~Valor,
  "Linf",  "Conjunto", 109.33, 
  "k",  "Conjunto", 0.12,
  "to", "Conjunto", -0.82
) |> gt()
```

El crecimiento individual fue modelado por medio de una clave talla-edad en base a los parámetros descritos
por el método de von-Bertalanffy (VBGM) para sexos conjunto. Varias estimaciones de crecimiento fueron
descritas en @zamora2021ecologia, donde se proporcionaron estimaciones de longitud infinita ($L_{\infty}$),
tasa de crecimiento individual ($k$), y edad a longitud cero ($t_0$) para sexos conjuntos.

La conversión desde talla a edad fue realizada asumiendo que los grupos de edad se describen por medio de una
talla modal (i.e., talla media) y su variación en el grupo (i.e., desviación estándar), asumiendo una
distribución normal. Para esto, se simuló la talla de reclutamiento a la pesquería desde las composiciones de
tamaños ([Datos/Tallas](../datos/01-tallas.qmd)) y se exploró el número de grupos de edad requeridos para
incorporar las tallas muestreadas (@fig-001).

```{r, warning=FALSE, echo=FALSE, message=FALSE}
#| fig-height: 5
#| fig-cap: "Participación de grupos de edad en el rango de tamaños (1-110 cm) que se incluye en el modelo."
#| label: fig-001
#| fig-column: body-outset-right

# growth Hembras & Machos
nedades = 30
Linf    = 109.33
k       = 0.12
Lo      = 15
t0      = 0
M       = 0.21

cv      = 0.2
tallas  = seq(0,110) #floor(Linf))

mu_edad = sigma_edad = NULL
mu_edad[1] = Lo;

for (i in 2:nedades) {
  mu_edad[i] = mu_edad[i-1]*exp(-k)+Linf*(1-exp(-k))
}
sigma_edad = cv*mu_edad

# mixture
propo1 <- rep(1/nedades,1,nedades)
N = rep(1,1,nedades)
prop <- for (i in 2:nedades) {
  N[i] = N[i-1]*exp(-M)
}
propo2 = N/sum(N)

x <- rmixnorm(n = 5000, mean = mu_edad, sd = sigma_edad, pro = propo2)

## Veamos
dbins = 2
set_tallas <- tibble(length = x) |> filter(length > 0) |> rowwise() |> 
  mutate(age = DLMtool::iVB(t0, k, Linf, length), bins = FSA::lencat(length, w=dbins)) |> 
  drop_na() |> mutate(agec = ceiling(age))

raw    <- xtabs(~bins+agec, data=set_tallas)
WR.key <- prop.table(raw, margin=1)
#View(WR.key)

maxedad = 30
wr.key <- WR.key[,c(1:maxedad)]

FSA::alkPlot(wr.key,"barplot", lbl.cex = 0.5, xlim = c(0,110), xlab = "Talla", ylab = "Proporción")
```

## Mortalidad Natural

Se empleó información previa para la mortalidad natural utilizada en evaluaciones realizadas en Estados Unidos
y Canadá. Los resultados del análisis utilizando el método de Hoenig (1983) respaldan el uso de una
distribución log-normal con una mediana de `M=0.21` y una desviación estándar logarítmica de `0.1`. La
sensibilidad a esta información ha sido evaluada extensamente en muchas evaluaciones anteriores de la merluza
del pacífico. Los supuestos sobre M suelen tener un impacto significativo en los resultados del modelo, pero
en ausencia de nueva información sobre `M`, ha habido pocas opciones para actualizar este parámetro.

## Escarpamiento

El valor del parámetro de escarpamiento de la función stock-recluta se fundamenta en datos de la mediana
(`0.79`) y los percentiles 20 (`0.67`) y 80 (`0.87`) de la meta-análisis de Myers et al. (1999) de la familia
Gadidae. Este valor se ha utilizado en evaluaciones de Estados Unidos desde 2007 y puede ser representado por
una distribución a-priori beta con parámetros 9.76 y 2.80, lo que resulta en una media de 0.777 y una
desviación estándar logarítmica de 0.113.

## Madurez

Se utilizo @ZamoraGarca2020. Estas muestras fueron recolectadas durante los cruceros de área barrida, viajes
de investigación acústica de invierno, del Programa de Observadores de Merluza en el Golfo de California,
México.

```{r, warning=FALSE, echo=FALSE, message=FALSE}
#| fig-height: 4
#| fig-cap: "Ojiva de madurez expresada en talla. Los puntos corresponden a los valores de madurez que se utilizarán en el modelo de evaluación para el rango de tallas entre 5 y 110 cm. La zona achurada corresponde a la madurez a la edad obtenida desde muestras empiricas. Las líneas verticales segmentadas muestran las edades desde 0.5, 1-15 grupos."
#| label: fig-002
#| fig-column: body-outset-right


Linf = 109.33
k = 0.12
to = -0.82
edad = seq(from = 0, to = 15, by = 0.01)
talla = seq(from = 1, to = 109, by = 2)

tallae <- function(Linf, k, to, edad){
  Lt = Linf * (1 - exp(-k * (edad - to)))
  return(Lt)
}
tallam <- tallae(Linf, k, to, edad)

edad2 <- c(0.5, seq(from = 1, to = 15, by = 1))
talla2 <- tibble(edad = edad2) |> mutate(talla =tallae(Linf, k, to, edad2))

beta0 = -1.67
beta1 = 0.58
madura <- function(beta0, beta1, edad){
  Pmad = exp(beta0 + beta1 * edad)/(1 + exp(beta0 + beta1 * edad))
  return(Pmad)
}
msex <- madura(beta0, beta1, edad)

mdata <- tibble(edad,tallam,msex)

extrap <- Hmisc::approxExtrap(tallam, msex, talla, method = "linear")
newmsex <- tibble(talla = extrap$x, msex = extrap$y)
newmsex[[2]][1:5] = 0
newmsex[[2]][48:55] = 1

mdata |> ggplot(aes(x = tallam, y = msex)) + 
  geom_path(color = mycolor2[1], linewidth = 4.3, alpha = 0.4) +
  geom_point(data = newmsex, aes(x = talla, y = msex), size = 2, color = mycolor[10]) +
  geom_vline(xintercept = talla2$talla, linetype = 2, color = mycolor3) +
  mitheme2(bz = 10) + expand_limits(y = 0) + scale_x_continuous(breaks = seq(from = 1, to = 109, by = 4)) +
  labs(x = "Talla [cm]", y = "Proporción") 

```
