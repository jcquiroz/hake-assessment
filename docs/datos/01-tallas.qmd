---
title: "Estructura de tallas"
subtitle: "Dinámica poblacional y selectividades"
subject: "Análisis"
---

```{r setup, echo=FALSE, include=FALSE}
source(here::here("R", "slide-things.R"))
library(readr)
library(readxl)
library(tidyverse)
library(gtsummary)

source("../R/functions.R")
```

Las composiciones de tamaños y los pesos medios en un modelo de evaluación poblacional permiten influir en dos
procesos importantes para la estimación de variables de estado (por ejemplo, biomasa y reclutamiento): (\i) el
crecimiento poblacional, que se refiere a cómo las cohortes progresan temporalmente en la dinámica
poblacional, describiendo la fuerza de los reclutamientos (es decir, un sustituto de los nacimientos) y (\ii)
determinar la fracción explotable de la población representada por las selectividades de la pesquería.

```{r, warning=FALSE, echo=FALSE, message=FALSE}
obs_2015 <- read_excel("data/obs_2015.xlsx", sheet = "Tallas", col_types = c("text", "numeric", "numeric", "date", "text", 
        "text", "text", "numeric", "numeric", "text", "text")) |> mutate(year = 2015)
obs_2016 <- read_excel("data/obs_2016.xlsx", sheet = "Tallas", col_types = c("text", "numeric", "numeric", "date", "text", 
        "text", "text", "numeric", "numeric", "numeric", "text", "text")) |> mutate(year = 2016)
obs_2017 <- read_excel("data/obs_2017.xlsx", sheet = "Tallas", col_types = c("text", "numeric", "numeric", "date", "text", 
        "numeric", "numeric", "text", "text")) |> mutate(year = 2017)
obs_2018 <- read_excel("data/obs_2018.xlsx", sheet = "Tallas", col_types = c("text", "text", "numeric", "numeric", "date", 
        "text", "numeric", "numeric", "text", "text")) |> mutate(year = 2018)
obs_2019 <- read_excel("data/obs_2019.xlsx", sheet = "Tallas") |> mutate(year = 2019)
obs_2020 <- read_excel("data/obs_2020.xlsx", sheet = "Tallas") |> mutate(year = 2020)
obs_2021 <- read_excel("data/obs_2021.xlsx", sheet = "Tallas", col_types = c("text", "text", "text", "text", "numeric", "numeric", "text", "text")) |> mutate(year = 2021)
obs_2022 <- read_excel("data/obs_2022.xlsx", sheet = "Tallas", col_types = c("text", "text", "text", "numeric", "numeric", "text", "text")) |> mutate(year = 2022)
obs_2023 <- read_excel("data/obs_2023.xlsx", sheet = "Tallas") |> mutate(year = 2023)

obs_all <- bind_rows(obs_2015,obs_2016,obs_2017,obs_2018,obs_2019,obs_2020,obs_2021,obs_2022,obs_2023)
```

## Estadísticas

La @tbl-001 muestra que existen diferencias significativas entre las tallas, pesos y número de muestras
obtenidas de la captura comercial y la descartada. Este patrón se repite en toda la información disponible
para el período 2015 - 2023.

```{r, warning=FALSE, message=FALSE}
#| tbl-cap: "Estadisticas por tipo de captura (comercial versus descarte). Porcentaje aplica entre niveles para cada factor."
#| tbl-column: body-outset-right
#| label: tbl-001

theme_gtsummary_language(language = "es")
obs_all |>  tbl_summary(include = c(year, sexo, peso, talla), by = destino, missing = "ifany", type = all_continuous() ~ "continuous2",
  statistic = all_continuous() ~ c("{mean} ({sd})", "{min} - {max}"), percent = c("column"), digits = all_continuous() ~ 0,
  label = list(year ~ "Año", sexo ~ "Sexo", peso ~ "Peso", talla ~ "Talla"), missing_text = "(Missing)") |> 
  add_overall(col_label = "**Totales** \n\n N = {style_number(N)}", last = TRUE) |> 
  add_n(col_label = "**Muestras, n**", last = TRUE, footnote = FALSE) |> add_p(test = everything() ~ "t.test") |> 
  bold_labels() |>  modify_header(label = "**Factor**") 

obs_all |>  tbl_summary(include = c(year, sexo), by = destino, missing = "ifany", percent = c("column"), 
  label = list(year ~ "Año", sexo ~ "Sexo"), missing_text = "(Missing)") |> 
  add_overall(col_label = "**Totales** \n\n N = {style_number(N)}", last = TRUE) |> 
  add_n(col_label = "**Muestras, n**", last = TRUE, footnote = FALSE) |> add_p() |> 
  bold_labels() |>  modify_header(label = "**Factor**") 

```

## Estructura de tallas

```{r, warning=FALSE, message=FALSE}
#| fig-cap: "Estructura de tamaño de merluza del pacífico"
#| label: fig-001
#| fig-height: 9

bd = 2
bg.brks <- seq(0,110,bd)

tmp <- obs_all |> filter(sexo %in% c("M","H")) |> drop_na(destino,sexo) |> 
  reframe(armo_talla(talla,bg.brks), .by = c(year,destino,sexo)) |> mutate(across(sexo, ~ fct_recode(.x, "Machos" = "M", "Hembras" = "H")))

ggplot(data = tmp, aes(mids,freq)) + geom_col(aes(fill = destino), width = NULL, position = "dodge") + 
  facet_grid(year ~ sexo, scales = "free_y") + mitheme2(bz = 9) + scale_fill_manual(values = mycolor[c(9,2)]) + 
  labs(x = "Talla [cm]", y = "Proporción", fill = "Procedencia")
```

## Modelos de regresión

Valores de modelos de regresión de la forma $W = a*L^b$ serán utilizados para modelar el crecimiento basado en
tallas.

```{r, warning=FALSE, message=FALSE}

library(GGally)
library(labelled)

obs_all_log <- obs_all |> drop_na(year,peso,talla) |> mutate(yearf = factor(year), logW = log(peso), logL = log(talla)) |> 
  set_variable_labels( yearf = "Año", logL = "Isometría", logW = "Pendiente" )

mod01 <- glm(logW ~ logL * yearf, data = obs_all_log)
ggcoef_model(mod01, intercept = TRUE, signif_stars = FALSE, facet_row = NULL, stripped_rows = TRUE) + 
  labs(x = NULL) + scale_colour_manual(values = mycolor[c(2,4,8,11)])


tbl_regression(mod01, conf.level = 0.75, intercept = TRUE, exponentiate = FALSE) |> modify_header(label = "Parámetros") 
#|> plot(remove_header_rows = TRUE, remove_reference_rows = FALSE)

```

```{r, warning=FALSE, message=FALSE}
#| fig-width: 8
#| fig-height: 10
#| fig-cap: "Relación longitud-peso de merluza del pacífico"

obs_all |> drop_na(destino) |> ggplot(aes(talla,peso)) + geom_point(aes(color = sexo), size = 2, alpha = 0.6) + 
  facet_wrap(year ~ destino, ncol = 2, scales = "free_y", dir = "v") + mitheme() + scale_color_manual(values = mycolor[c(9,2)]) + 
  labs(title = "Relación L-W año 2020", x = "Talla [cm]", y = "Peso [gr]", color = "Sexo")
```
